<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dividend Screener (DK + US)</title>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0e172a;
      --panel2:#111c33;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#22304a;
      --accent:#60a5fa;
    }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% 0%, #142042 0%, var(--bg) 55%) fixed;
      color: var(--text);
    }
    .wrap{ max-width: 1300px; margin: 28px auto; padding: 0 16px; }
    h1{ font-size: 28px; margin: 0 0 6px 0; }
    .sub{ color: var(--muted); font-size: 13px; margin-bottom: 14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .badge{ padding: 2px 8px; border:1px solid var(--border); border-radius: 999px; background: rgba(255,255,255,0.03); }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    /* DataTables dark-ish */
    table.dataTable{ color: var(--text); background: transparent; }
    table.dataTable thead th{
      background: rgba(255,255,255,0.02);
      color: var(--text);
      border-bottom: 1px solid var(--border) !important;
      font-weight: 600;
    }
    table.dataTable tbody td{
      border-top: 1px solid rgba(34,48,74,0.45);
    }
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate{
      color: var(--muted) !important;
    }
    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select{
      background: rgba(255,255,255,0.04);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      outline: none;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button{
      color: var(--muted) !important;
      border-radius: 10px;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current{
      background: rgba(96,165,250,0.15) !important;
      border: 1px solid rgba(96,165,250,0.35) !important;
      color: var(--text) !important;
    }
    .muted{ color: var(--muted); }
    .ok{ color: #86efac; }
    .err{ color: #fca5a5; }
    .small{ font-size: 12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Dividend Screener (DK + US)</h1>
    <div class="sub">
      <span id="status" class="badge">Loading data…</span>
      <span id="meta" class="badge muted">—</span>
      <span class="badge muted small">Tip: Cmd+Shift+R if you just updated files</span>
    </div>

    <div class="panel">
      <table id="screener" class="display" style="width:100%"></table>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

  <!-- Proper CSV parser (handles commas inside fields) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // IMPORTANT: relative path works for GitHub Pages project sites
    const CSV_PATH = "data/screener_results/screener_results.csv";

    // Preferred column order (we will include any extra columns after these)
    const PREFERRED = [
      "GeneratedUTC",
      "Ticker",
      "Name",
      "Country",
      "Currency",
      "Exchange",
      "Sector",
      "Industry",
      "Price",
      "DividendYield_%",
      "PayoutRatio_%",
      "PE",
      "Signal",
      "Score",
      "Upside_%",
      "Upside_Yield_%"
    ];

    function setStatus(text, cls){
      const el = document.getElementById("status");
      el.textContent = text;
      el.className = "badge " + (cls || "muted");
    }

    function toNumberMaybe(v){
      if (v === null || v === undefined) return null;
      const s = String(v).trim();
      if (s === "") return null;
      // try parse float safely
      const n = Number(s);
      return Number.isFinite(n) ? n : s;
    }

    function buildColumns(headers){
      // order = preferred first, then the rest (stable)
      const preferred = PREFERRED.filter(h => headers.includes(h));
      const rest = headers.filter(h => !preferred.includes(h));
      const ordered = preferred.concat(rest);

      const columns = ordered.map(h => {
        // basic numeric alignment for common numeric fields
        const numericLike = /(Yield|Payout|Price|PE|Upside|Score|MarketCap|Beta|Growth|CAGR|Return)/i.test(h);
        return {
          title: h,
          data: h,
          className: numericLike ? "dt-body-right" : "dt-body-left",
          render: function(data, type){
            if (type !== "display") return data;

            // Show blank cleanly
            if (data === null || data === undefined || data === "") return "";

            // Pretty format for numbers
            if (typeof data === "number"){
              // percent-like columns: keep 2 decimals
              if (/%/.test(h) || /(Yield|Payout|Upside)/i.test(h)){
                return data.toFixed(2);
              }
              // Price: 2 decimals
              if (/Price/i.test(h)) return data.toFixed(2);
              // Other: up to 2 decimals
              return Number.isInteger(data) ? data : data.toFixed(2);
            }

            return String(data);
          }
        };
      });

      return { ordered, columns };
    }

    function initTable(rows){
      if (!rows || rows.length === 0){
        setStatus("No rows found in CSV", "err");
        return;
      }

      // Normalize keys + numeric conversion
      const headers = Object.keys(rows[0]).filter(Boolean);
      const { ordered, columns } = buildColumns(headers);

      const normalized = rows.map(r => {
        const o = {};
        ordered.forEach(k => o[k] = toNumberMaybe(r[k]));
        return o;
      });

      // meta line: generated time if present in first row
      const gen = normalized[0]["GeneratedUTC"] ? String(normalized[0]["GeneratedUTC"]) : "";
      document.getElementById("meta").textContent =
        `Loaded ${normalized.length} rows from ${CSV_PATH}` + (gen ? ` • Generated: ${gen}` : "");

      setStatus("Data loaded ✅", "ok");

      // Create table header explicitly (DataTables likes this)
      const thead = "<thead><tr>" + ordered.map(h => `<th>${h}</th>`).join("") + "</tr></thead>";
      document.getElementById("screener").innerHTML = thead;

      $("#screener").DataTable({
        data: normalized,
        columns: columns,
        pageLength: 50,
        deferRender: true,
        fixedHeader: true,
        order: [],
        scrollX: true
      });
    }

    // Fetch + parse CSV robustly (handles commas inside fields)
    Papa.parse(CSV_PATH, {
      download: true,
      header: true,
      skipEmptyLines: true,
      dynamicTyping: true,
      complete: function(results){
        if (results.errors && results.errors.length){
          console.warn("CSV parse warnings/errors:", results.errors);
        }
        initTable(results.data || []);
      },
      error: function(err){
        console.error(err);
        setStatus(`Error loading CSV: ${err}`, "err");
      }
    });
  </script>
</body>
</html>
