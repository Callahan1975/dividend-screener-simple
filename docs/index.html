<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dividend Screener (DK + US)</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.0.8/css/dataTables.dataTables.min.css">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --text:#e7eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.08);
      --chip:#122442;
    }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1200px; margin:28px auto; padding:0 18px; }
    h1{ margin:0 0 8px; font-size:28px; }
    .bar{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background:var(--panel); border:1px solid var(--line); border-radius:14px;
      padding:12px 12px;
      margin:12px 0 14px;
    }
    .chip{ background:var(--chip); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); }
    .ok{ color:#3ddc84; font-weight:600; }
    .err{ color:#ff6b6b; font-weight:600; }

    table.dataTable{ background:transparent; color:var(--text); }
    table.dataTable thead th{ color:var(--muted); border-bottom:1px solid var(--line) !important; }
    table.dataTable tbody td{ border-bottom:1px solid var(--line) !important; }
    .dt-search input, .dt-length select{
      background:#0b1730 !important; color:var(--text) !important;
      border:1px solid var(--line) !important; border-radius:10px !important;
      padding:6px 10px !important;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Dividend Screener (DK + US)</h1>

    <div class="bar">
      <span id="status" class="chip">Loading…</span>
      <span id="meta" class="chip"></span>
      <span class="chip">Tip: Cmd+Shift+R hvis du lige har opdateret filer</span>
    </div>

    <table id="tbl" class="display" style="width:100%"></table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.0.8/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_PATH = "data/screener_results/screener_results.csv";

    const COLS = [
      { key:"GeneratedUTC", title:"GeneratedUTC" },
      { key:"Ticker", title:"Ticker" },
      { key:"Name", title:"Name" },
      { key:"Country", title:"Country" },
      { key:"Currency", title:"Currency" },
      { key:"Exchange", title:"Exchange" },
      { key:"Sector", title:"Sector" },
      { key:"Industry", title:"Industry" },
      { key:"Price", title:"Price", render:numRender(4) },
      { key:"DividendYield_%", title:"DividendYield_%", render:pctRender(2) },
      { key:"PayoutRatio_%", title:"PayoutRatio_%", render:pctRender(2) },
      { key:"PE", title:"PE", render:numRender(2) },
    ];

    function numRender(decimals){
      return function(data){
        if(data===null || data===undefined || data==="") return "";
        const v = Number(data);
        if(!Number.isFinite(v)) return data;
        return v.toFixed(decimals);
      }
    }

    function pctRender(decimals){
      return function(data){
        if(data===null || data===undefined || data==="") return "";
        const v = Number(data);
        if(!Number.isFinite(v)) return data;
        return v.toFixed(decimals);
      }
    }

    function setStatusOk(msg){
      const el = document.getElementById("status");
      el.innerHTML = `<span class="ok">Data loaded ✓</span>`;
      document.getElementById("meta").textContent = msg;
    }

    function setStatusErr(msg){
      const el = document.getElementById("status");
      el.innerHTML = `<span class="err">Error:</span> ${msg}`;
      document.getElementById("meta").textContent = "";
    }

    fetch(CSV_PATH, { cache: "no-store" })
      .then(r => {
        if(!r.ok) throw new Error(`CSV not found (${r.status}) at ${CSV_PATH}`);
        return r.text();
      })
      .then(text => {
        const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
        if(parsed.errors && parsed.errors.length){
          console.warn(parsed.errors);
        }

        const rows = parsed.data || [];
        const gen = rows[0]?.GeneratedUTC || "";
        setStatusOk(`Loaded ${rows.length} rows from ${CSV_PATH} • Generated: ${gen}`);

        // build table header from COLS
        $("#tbl").html(
          "<thead><tr>" + COLS.map(c => `<th>${c.title}</th>`).join("") + "</tr></thead>"
        );

        $("#tbl").DataTable({
          data: rows,
          columns: COLS.map(c => ({
            title: c.title,
            data: c.key,
            render: c.render
          })),
          pageLength: 50,
          order: [[0, "desc"]],
          deferRender: true,
        });
      })
      .catch(err => {
        console.error(err);
        setStatusErr(err.message);
      });
  </script>
</body>
</html>
