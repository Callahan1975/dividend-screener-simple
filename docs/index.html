<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dividend Screener (DK + US)</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.1.8/css/dataTables.dataTables.min.css">

  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 18px; background:#0b1220; color:#e6edf3; }
    h1 { font-size: 22px; margin: 0 0 10px; }
    .bar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 8px 0 14px; }
    .pill { padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:rgba(255,255,255,.04); font-size:12px; }
    select, input { background:#0f1a2d; border:1px solid rgba(255,255,255,.14); color:#e6edf3; border-radius:10px; padding:6px 10px; }
    table.dataTable { width:100% !important; }
    table.dataTable thead th { background:#0f1a2d; color:#e6edf3; }
    table.dataTable tbody td { background:#0b1220; color:#e6edf3; }
    .dt-container .dt-paging .dt-paging-button { color:#e6edf3 !important; }
    .muted { opacity:.75; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <h1>Dividend Screener (DK + US)</h1>

  <div class="bar">
    <span id="status" class="pill">Loading data…</span>

    <label class="muted">Country</label>
    <select id="fCountry"><option value="">All</option></select>

    <label class="muted">Currency</label>
    <select id="fCurrency"><option value="">All</option></select>

    <label class="muted">Exchange</label>
    <select id="fExchange"><option value="">All</option></select>

    <label class="muted">Sector</label>
    <select id="fSector"><option value="">All</option></select>

    <button id="reset" class="pill" style="cursor:pointer;">Reset</button>
    <span class="pill muted">Tip: Cmd+Shift+R efter opdatering</span>
  </div>

  <table id="screener" class="display"></table>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.1.8/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_PATH = "data/screener_results/screener_results.csv";

    function uniqSorted(values) {
      const s = new Set(values.filter(v => v !== null && v !== undefined && String(v).trim() !== ""));
      return Array.from(s).sort((a,b) => String(a).localeCompare(String(b)));
    }

    function fmtNum(x, nd=2) {
      if (x === null || x === undefined || x === "") return "";
      const n = Number(x);
      if (!isFinite(n)) return "";
      return n.toFixed(nd);
    }

    function fmtPct(x, nd=2) {
      if (x === null || x === undefined || x === "") return "";
      const n = Number(x);
      if (!isFinite(n)) return "";
      return n.toFixed(nd) + "%";
    }

    fetch(CSV_PATH, { cache: "no-store" })
      .then(r => {
        if (!r.ok) throw new Error("CSV not found: " + CSV_PATH);
        return r.text();
      })
      .then(text => {
        const parsed = Papa.parse(text, {
          header: true,
          dynamicTyping: false,
          skipEmptyLines: true
        });

        if (parsed.errors && parsed.errors.length) {
          console.error("PapaParse errors:", parsed.errors);
        }

        const rows = parsed.data || [];
        if (!rows.length) throw new Error("CSV parsed but no rows");

        const headers = Object.keys(rows[0]);

        // Build header
        $("#screener").html(
          "<thead><tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr></thead>"
        );

        // Convert to DataTables row arrays in header order
        const data = rows.map(r => headers.map(h => r[h] ?? ""));

        const idx = (name) => headers.indexOf(name);

        const table = new DataTable("#screener", {
          data,
          columns: headers.map(h => ({ title: h })),
          pageLength: 50,
          order: [[0, "desc"]],
          autoWidth: false,
          columnDefs: [
            // Make ticker monospace if present
            { targets: idx("Ticker"), createdCell: (td) => td.classList.add("mono") },

            // Price
            { targets: idx("Price"), render: (d) => fmtNum(d, 2) },

            // Percent columns (safe even if missing)
            {
              targets: [idx("DividendYield_%"), idx("PayoutRatio_%")].filter(i => i >= 0),
              render: (d) => fmtPct(d, 2)
            },

            // PE
            { targets: idx("PE"), render: (d) => fmtNum(d, 2) }
          ].filter(x => x.targets !== -1)
        });

        // Dropdown filters
        const idxCountry  = idx("Country");
        const idxCurrency = idx("Currency");
        const idxExchange = idx("Exchange");
        const idxSector   = idx("Sector");

        const countryVals  = idxCountry >= 0 ? uniqSorted(data.map(r => r[idxCountry])) : [];
        const currencyVals = idxCurrency >= 0 ? uniqSorted(data.map(r => r[idxCurrency])) : [];
        const exchangeVals = idxExchange >= 0 ? uniqSorted(data.map(r => r[idxExchange])) : [];
        const sectorVals   = idxSector >= 0 ? uniqSorted(data.map(r => r[idxSector])) : [];

        function fillSelect(sel, values) {
          values.forEach(v => $(sel).append(`<option value="${String(v)}">${String(v)}</option>`));
        }

        fillSelect("#fCountry", countryVals);
        fillSelect("#fCurrency", currencyVals);
        fillSelect("#fExchange", exchangeVals);
        fillSelect("#fSector", sectorVals);

        function applyFilter(sel, idxCol) {
          if (idxCol < 0) return;
          const v = $(sel).val();
          table.column(idxCol).search(v ? "^" + v.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "$" : "", true, false).draw();
        }

        $("#fCountry").on("change", () => applyFilter("#fCountry", idxCountry));
        $("#fCurrency").on("change", () => applyFilter("#fCurrency", idxCurrency));
        $("#fExchange").on("change", () => applyFilter("#fExchange", idxExchange));
        $("#fSector").on("change", () => applyFilter("#fSector", idxSector));

        $("#reset").on("click", () => {
          $("#fCountry,#fCurrency,#fExchange,#fSector").val("");
          table.search("").columns().search("").draw();
        });

        const generatedUTC = rows[0]["GeneratedUTC"] ? String(rows[0]["GeneratedUTC"]) : "";
        document.getElementById("status").innerText =
          `Data loaded ✅  Loaded ${rows.length} rows from ${CSV_PATH}` + (generatedUTC ? ` · Generated: ${generatedUTC}` : "");
      })
      .catch(err => {
        document.getElementById("status").innerText = "Error: " + err.message;
        console.error(err);
      });
  </script>
</body>
</html>
