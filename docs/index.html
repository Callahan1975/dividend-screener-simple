<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dividend Screener (DK + US)</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.1.8/css/dataTables.dataTables.min.css">

  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin: 18px; background:#0b1220; color:#e6edf3; }
    h1 { font-size: 22px; margin: 0 0 10px; }
    .bar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 8px 0 14px; }
    .pill { padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:rgba(255,255,255,.04); font-size:12px; }
    select, input { background:#0f1a2d; border:1px solid rgba(255,255,255,.14); color:#e6edf3; border-radius:10px; padding:6px 10px; }
    table.dataTable { width:100% !important; }
    table.dataTable thead th { background:#0f1a2d; color:#e6edf3; }
    table.dataTable tbody td { background:#0b1220; color:#e6edf3; }
    .dt-container .dt-paging .dt-paging-button { color:#e6edf3 !important; }
    .muted { opacity:.75; }
  </style>
</head>

<body>
  <h1>Dividend Screener (DK + US)</h1>

  <div class="bar">
    <span id="status" class="pill">Loading data…</span>

    <label class="muted">Country</label>
    <select id="fCountry"><option value="">All</option></select>

    <label class="muted">Currency</label>
    <select id="fCurrency"><option value="">All</option></select>

    <label class="muted">Exchange</label>
    <select id="fExchange"><option value="">All</option></select>

    <label class="muted">Sector</label>
    <select id="fSector"><option value="">All</option></select>

    <button id="reset" class="pill" style="cursor:pointer;">Reset</button>
  </div>

  <table id="screener" class="display"></table>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.1.8/js/dataTables.min.js"></script>

  <script>
    const CSV_PATH = "data/screener_results/screener_results.csv";

    function parseCSV(text) {
      // simple CSV parser (works because our output has no quoted commas)
      const lines = text.trim().split("\n");
      const headers = lines.shift().split(",");
      const data = lines.map(line => line.split(","));
      return { headers, data };
    }

    function uniqSorted(values) {
      const s = new Set(values.filter(v => v && v.trim() !== ""));
      return Array.from(s).sort((a,b) => a.localeCompare(b));
    }

    function fmtNum(x) {
      if (x === null || x === undefined || x === "") return "";
      const n = Number(x);
      if (!isFinite(n)) return "";
      return n.toFixed(2);
    }

    function fmtPct(x) {
      if (x === null || x === undefined || x === "") return "";
      const n = Number(x);
      if (!isFinite(n)) return "";
      return n.toFixed(2) + "%";
    }

    fetch(CSV_PATH, { cache: "no-store" })
      .then(r => {
        if (!r.ok) throw new Error("CSV not found: " + CSV_PATH);
        return r.text();
      })
      .then(text => {
        const { headers, data } = parseCSV(text);

        // Build the table header dynamically
        $("#screener").html(
          "<thead><tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr></thead>"
        );

        const table = new DataTable("#screener", {
          data,
          columns: headers.map(h => ({ title: h })),
          pageLength: 50,
          order: [[0, "desc"]],
          autoWidth: false,
          columnDefs: [
            // Price
            {
              targets: headers.indexOf("Price"),
              render: (d) => fmtNum(d)
            },
            // DividendYield_% and PayoutRatio_%
            {
              targets: [headers.indexOf("DividendYield_%"), headers.indexOf("PayoutRatio_%")].filter(i => i >= 0),
              render: (d) => fmtPct(d)
            },
            // PE
            {
              targets: headers.indexOf("PE"),
              render: (d) => fmtNum(d)
            }
          ]
        });

        // Build dropdown filters (by column name)
        function colIndex(name) { return headers.indexOf(name); }

        const idxCountry  = colIndex("Country");
        const idxCurrency = colIndex("Currency");
        const idxExchange = colIndex("Exchange");
        const idxSector   = colIndex("Sector");

        const countryVals  = uniqSorted(data.map(r => r[idxCountry]));
        const currencyVals = uniqSorted(data.map(r => r[idxCurrency]));
        const exchangeVals = uniqSorted(data.map(r => r[idxExchange]));
        const sectorVals   = uniqSorted(data.map(r => r[idxSector]));

        function fillSelect(sel, values) {
          values.forEach(v => $(sel).append(`<option value="${v}">${v}</option>`));
        }

        fillSelect("#fCountry", countryVals);
        fillSelect("#fCurrency", currencyVals);
        fillSelect("#fExchange", exchangeVals);
        fillSelect("#fSector", sectorVals);

        function applyFilter(sel, idx) {
          const v = $(sel).val();
          // exact match
          table.column(idx).search(v ? "^" + v.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") + "$" : "", true, false).draw();
        }

        $("#fCountry").on("change", () => applyFilter("#fCountry", idxCountry));
        $("#fCurrency").on("change", () => applyFilter("#fCurrency", idxCurrency));
        $("#fExchange").on("change", () => applyFilter("#fExchange", idxExchange));
        $("#fSector").on("change", () => applyFilter("#fSector", idxSector));

        $("#reset").on("click", () => {
          $("#fCountry,#fCurrency,#fExchange,#fSector").val("");
          table.search("").columns().search("").draw();
        });

        const generatedUTC = data[0] && data[0][headers.indexOf("GeneratedUTC")] ? data[0][headers.indexOf("GeneratedUTC")] : "";
        document.getElementById("status").innerText = `Data loaded ✅  Loaded ${data.length} rows from ${CSV_PATH}` + (generatedUTC ? ` · Generated: ${generatedUTC}` : "");
      })
      .catch(err => {
        document.getElementById("status").innerText = "Error: " + err.message;
        console.error(err);
      });
  </script>
</body>
</html>
