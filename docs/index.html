<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dividend Screener – Decision View</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .sub { margin: 0 0 14px; color: #555; font-size: 13px; }

    .bar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0 10px; }
    .pill { padding: 6px 10px; border: 1px solid #eee; border-radius: 999px; background:#fafafa; font-size: 13px; }
    .pill b { font-weight: 700; }
    .muted { color:#777; }

    table.dataTable thead th { white-space: nowrap; }
    table.dataTable tbody td { padding: 6px 8px; }

    td.details-control {
      cursor: pointer;
      text-align: center;
      user-select: none;
      width: 28px;
      color: #333;
      font-weight: 700;
    }

    .details-box {
      padding: 10px 14px;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 10px;
      margin: 6px 0;
    }
    .kv {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 6px 12px;
      align-items: start;
      font-size: 13px;
    }
    .kv .key { color: #666; }
    .kv .val { color: #111; overflow-wrap: anywhere; }

    /* Signal badges */
    .sig { display:inline-block; padding: 2px 10px; border-radius: 999px; border:1px solid #eee; font-weight:700; font-size:12px; }
    .sig-GOLD  { background:#fff7db; border-color:#f1c40f55; color:#8a6d00; }
    .sig-BUY   { background:#eaf2ff; border-color:#0b6efd55; color:#0b4bb3; }
    .sig-HOLD  { background:#f2f2f2; border-color:#99999933; color:#444; }
    .sig-WATCH { background:#f6f6f6; border-color:#bbbbbb33; color:#777; }

    /* Confidence chips */
    .conf { display:inline-block; padding: 2px 10px; border-radius: 999px; border:1px solid #eee; font-weight:700; font-size:12px; }
    .conf-High { background:#eaf7ef; border-color:#19875455; color:#13703f; }
    .conf-Med  { background:#fff4e6; border-color:#fd7e1455; color:#a34f00; }
    .conf-Low  { background:#fff0f0; border-color:#dc354555; color:#8b1d2a; }

    /* Filters */
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 8px 0 14px; }
    .filters label { font-size: 13px; color:#333; }
    .filters select { padding: 6px 8px; border:1px solid #ddd; border-radius: 10px; background:#fff; }
    .filters button { padding: 6px 10px; border:1px solid #ddd; border-radius: 10px; background:#fff; cursor:pointer; }
    .filters button:hover { background:#f7f7f7; }

    #errorBox { display:none; padding:12px 14px; border:1px solid #f5c2c7; background:#f8d7da; color:#842029; border-radius:10px; margin:12px 0; }

    .dataTables_wrapper .dataTables_filter input { padding: 6px 8px; }
    .dataTables_wrapper .dataTables_length select { padding: 4px 6px; }
  </style>
</head>

<body>
  <h1>Dividend Screener – Decision View</h1>
  <p class="sub">
    Sort: <b>Signal → Score → Upside</b>. Use dropdowns to filter. Click <b>▸</b> for full details.
  </p>

  <div class="bar">
    <span class="pill"><b>Tip:</b> Filter “GOLD/BUY” for “røverkøb”, sort on Upside/Score.</span>
    <span class="pill muted" id="meta"></span>
  </div>

  <div class="filters">
    <label>Signal:
      <select id="filterSignal">
        <option value="">All</option>
        <option value="GOLD">GOLD</option>
        <option value="BUY">BUY</option>
        <option value="HOLD">HOLD</option>
        <option value="WATCH">WATCH</option>
      </select>
    </label>

    <label>Confidence:
      <select id="filterConf">
        <option value="">All</option>
        <option value="High">High</option>
        <option value="Med">Med</option>
        <option value="Low">Low</option>
      </select>
    </label>

    <label>Sector:
      <select id="filterSector">
        <option value="">All</option>
      </select>
    </label>

    <button id="resetFilters" type="button">Reset</button>
  </div>

  <div id="errorBox"></div>

  <table id="screener" class="display compact" style="width:100%">
    <thead>
      <tr>
        <th></th>
        <th>Name</th>
        <th>Country</th>
        <th>Sector</th>
        <th>Currency</th>
        <th>Price</th>
        <th>Yield</th>
        <th>Upside</th>
        <th>Score</th>
        <th>Signal</th>
        <th>Conf</th>
        <th>Why</th>
      </tr>
    </thead>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_PATH = "data/screener_results/screener_results.csv";

    function showError(msg) {
      const el = document.getElementById("errorBox");
      el.style.display = "block";
      el.textContent = msg;
    }

    function fmtNum(d, digits=2, suffix="") {
      if (d == null || d === "" || Number.isNaN(d)) return "";
      return Number(d).toFixed(digits) + suffix;
    }

    function safeStr(v) {
      if (v == null) return "";
      return String(v);
    }

    // Custom sort for Signal: GOLD > BUY > HOLD > WATCH
    const signalOrder = { "GOLD": 1, "BUY": 2, "HOLD": 3, "WATCH": 4 };
    $.fn.dataTable.ext.type.order["signal-pre"] = function (d) {
      return signalOrder[d] || 99;
    };

    function formatDetails(rowData) {
      const quick = new Set([
        "Name","Country","Sector","Currency","Price","DividendYield_%","Upside_%","Score","Signal","Confidence","Why"
      ]);

      const keys = Object.keys(rowData || {})
        .filter(k => !quick.has(k))
        .sort();

      if (keys.length === 0) {
        return `<div class="details-box"><em>No additional fields in CSV.</em></div>`;
      }

      const rows = keys.map(k => {
        let v = rowData[k];
        if (v == null) v = "";
        return `<div class="key">${k}</div><div class="val">${safeStr(v)}</div>`;
      }).join("");

      return `<div class="details-box"><div class="kv">${rows}</div></div>`;
    }

    Papa.parse(CSV_PATH, {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      error: function(err) {
        showError("Could not load CSV at: " + CSV_PATH + " — " + (err?.message || err));
      },
      complete: function(results) {
        const rows = (results.data || []).filter(r => r && (r["Name"] || r["Ticker"]));

        // meta
        const meta = document.getElementById("meta");
        meta.textContent = rows.length ? (`Rows: ${rows.length} • CSV: ${CSV_PATH}`) : (`Rows: 0 • CSV: ${CSV_PATH}`);

        if (!rows.length) {
          showError("CSV loaded, but 0 rows found. Check that file exists and contains 'Name' column.");
        }

        // Ensure Name exists
        rows.forEach(r => {
          if (!r["Name"] && r["Ticker"]) r["Name"] = r["Ticker"];
        });

        // Build Sector dropdown from data
        const sectorSet = new Set();
        rows.forEach(r => { if (r["Sector"]) sectorSet.add(r["Sector"]); });
        const sectorSelect = document.getElementById("filterSector");
        [...sectorSet].sort().forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          sectorSelect.appendChild(opt);
        });

        const table = $("#screener").DataTable({
          data: rows,
          columns: [
            { data: null, className: "details-control", orderable: false, defaultContent: "▸" },

            { data: "Name", title: "Name" },
            { data: "Country", title: "Country" },

            { data: "Sector", title: "Sector", render: d => d ? safeStr(d) : "" },

            { data: "Currency", title: "Currency" },

            { data: "Price", title: "Price", render: d => fmtNum(d, 2, "") },

            { data: "DividendYield_%", title: "Yield", render: d => fmtNum(d, 2, "%") },

            { data: "Upside_%", title: "Upside", render: d => fmtNum(d, 1, "%") },

            { data: "Score", title: "Score", render: d => (d == null || d === "" || Number.isNaN(d)) ? "" : Math.round(Number(d)) },

            { data: "Signal", title: "Signal", type: "signal",
              render: d => d ? `<span class="sig sig-${d}">${d}</span>` : ""
            },

            { data: "Confidence", title: "Conf",
              render: d => d ? `<span class="conf conf-${d}">${d}</span>` : ""
            },

            { data: "Why", title: "Why", render: d => d ? safeStr(d) : "" },
          ],

          order: [
            [9, "asc"],  // Signal (custom)
            [8, "desc"], // Score
            [7, "desc"]  // Upside
          ],

          pageLength: 50,
          deferRender: true,
          autoWidth: false,
          fixedHeader: true
        });

        // Expand details
        $("#screener tbody").on("click", "td.details-control", function () {
          const tr = $(this).closest("tr");
          const row = table.row(tr);

          if (row.child.isShown()) {
            row.child.hide();
            tr.find("td.details-control").text("▸");
          } else {
            row.child(formatDetails(row.data())).show();
            tr.find("td.details-control").text("▾");
          }
        });

        // Dropdown filters: Signal + Confidence + Sector
        const colSignal = 9;
        const colConf = 10;
        const colSector = 3;

        $("#filterSignal").on("change", function () {
          const val = this.value;
          table.column(colSignal).search(val ? val : "", true, false).draw();
        });

        $("#filterConf").on("change", function () {
          const val = this.value;
          table.column(colConf).search(val ? val : "", true, false).draw();
        });

        $("#filterSector").on("change", function () {
          const val = this.value;
          table.column(colSector).search(val ? val : "", true, false).draw();
        });

        $("#resetFilters").on("click", function () {
          $("#filterSignal").val("");
          $("#filterConf").val("");
          $("#filterSector").val("");
          table.search("").columns().search("").draw();
        });
      }
    });
  </script>
</body>
</html>
