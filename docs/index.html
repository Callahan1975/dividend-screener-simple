<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dividend Screener (DK + US)</title>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0e1a2f;
      --text:#e7eefc;
      --muted:#9fb1d1;
      --border:rgba(255,255,255,.08);
      --chip:#122444;
    }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    .wrap{
      max-width: 1400px;
      margin: 22px auto;
      padding: 0 16px 30px;
    }
    h1{ margin:0 0 8px; font-size: 22px; font-weight: 700; }
    .sub{
      color: var(--muted);
      margin-bottom: 14px;
      font-size: 13px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }
    .controls{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: end;
      margin-bottom: 10px;
    }
    .ctrl{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 180px;
    }
    .ctrl label{
      font-size: 12px;
      color: var(--muted);
    }
    select, input{
      background: rgba(255,255,255,.04);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
    }
    select:focus, input:focus{
      border-color: rgba(124,160,255,.45);
      box-shadow: 0 0 0 3px rgba(124,160,255,.15);
    }
    button{
      background: var(--chip);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 9px 12px;
      cursor:pointer;
      height: 38px;
    }
    button:hover{ filter: brightness(1.1); }

    /* DataTables dark-ish */
    table.dataTable{ width:100% !important; color: var(--text); }
    table.dataTable thead th{
      background: rgba(255,255,255,.04);
      color: var(--muted);
      border-bottom: 1px solid var(--border) !important;
    }
    table.dataTable tbody td{
      border-bottom: 1px solid rgba(255,255,255,.05);
    }
    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select{
      background: rgba(255,255,255,.04);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
    }
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate{
      color: var(--muted) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button{
      color: var(--text) !important;
      border: 1px solid var(--border) !important;
      background: rgba(255,255,255,.03) !important;
      border-radius: 10px !important;
      margin-left: 6px;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current{
      background: rgba(124,160,255,.18) !important;
      border-color: rgba(124,160,255,.35) !important;
    }
    .err{
      color:#ffb3b3;
      font-weight:600;
    }
    .ok{
      color:#b8ffcf;
      font-weight:600;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Dividend Screener (DK + US)</h1>
    <div class="sub">
      <span id="status">Loading data…</span>
      <span id="meta" class="mono"></span>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="ctrl">
          <label for="fCountry">Country</label>
          <select id="fCountry"><option value="">All</option></select>
        </div>
        <div class="ctrl">
          <label for="fCurrency">Currency</label>
          <select id="fCurrency"><option value="">All</option></select>
        </div>
        <div class="ctrl">
          <label for="fExchange">Exchange</label>
          <select id="fExchange"><option value="">All</option></select>
        </div>
        <div class="ctrl">
          <label for="fSector">Sector</label>
          <select id="fSector"><option value="">All</option></select>
        </div>

        <button id="btnReset" type="button">Reset</button>
      </div>

      <table id="tbl" class="display" style="width:100%">
        <thead><tr></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // ✅ Pages bygger fra /docs, så denne relative sti er korrekt:
    const CSV_PATH = "data/screener_results/screener_results.csv";

    // ✅ EKSPPLICIT mapping (robust mod header quirks og % tegn)
    const columns = [
      { key: "GeneratedUTC",   title: "GeneratedUTC" },
      { key: "Ticker",         title: "Ticker" },
      { key: "Name",           title: "Name" },
      { key: "Country",        title: "Country" },
      { key: "Currency",       title: "Currency" },
      { key: "Exchange",       title: "Exchange" },
      { key: "Sector",         title: "Sector" },
      { key: "Industry",       title: "Industry" },
      { key: "Price",          title: "Price" },
      { key: "DividendYield_%",title: "DividendYield %" },
      { key: "PayoutRatio_%",  title: "PayoutRatio %" },
      { key: "PE",             title: "PE" }
    ];

    function setStatus(msg, ok=false){
      const el = document.getElementById("status");
      el.textContent = msg;
      el.className = ok ? "ok" : "";
    }
    function setError(msg){
      const el = document.getElementById("status");
      el.textContent = msg;
      el.className = "err";
    }

    function normHeaderKey(k){
      // robust mod BOM + whitespace + weird CR
      return (k ?? "")
        .toString()
        .replace(/^\uFEFF/, "")
        .replace(/\r/g, "")
        .trim();
    }

    function toNumberOrEmpty(v){
      if (v === null || v === undefined) return "";
      const s = String(v).trim();
      if (!s) return "";
      const n = Number(s);
      return Number.isFinite(n) ? n : s;
    }

    function uniqueSorted(arr){
      const s = new Set(arr.filter(v => v !== "" && v !== null && v !== undefined));
      return Array.from(s).sort((a,b) => String(a).localeCompare(String(b)));
    }

    function fillSelect(selectId, values){
      const sel = document.getElementById(selectId);
      const current = sel.value;
      sel.innerHTML = `<option value="">All</option>` + values.map(v => `<option value="${String(v).replace(/"/g,'&quot;')}">${v}</option>`).join("");
      // keep selection if possible
      if ([...sel.options].some(o => o.value === current)) sel.value = current;
    }

    function applyFilter(dt, colIndex, value){
      // exact match (escaped) when value chosen
      if (!value) {
        dt.column(colIndex).search("", true, false).draw();
        return;
      }
      const escaped = value.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      dt.column(colIndex).search("^" + escaped + "$", true, false).draw();
    }

    function buildFilters(dt){
      const idxCountry  = columns.findIndex(c => c.key === "Country");
      const idxCurrency = columns.findIndex(c => c.key === "Currency");
      const idxExchange = columns.findIndex(c => c.key === "Exchange");
      const idxSector   = columns.findIndex(c => c.key === "Sector");

      // Fill dropdowns based on currently loaded table data
      const colData = (idx) => dt.column(idx).data().toArray().map(v => (v ?? "").toString()).filter(Boolean);

      fillSelect("fCountry",  uniqueSorted(colData(idxCountry)));
      fillSelect("fCurrency", uniqueSorted(colData(idxCurrency)));
      fillSelect("fExchange", uniqueSorted(colData(idxExchange)));
      fillSelect("fSector",   uniqueSorted(colData(idxSector)));

      document.getElementById("fCountry").onchange  = (e) => applyFilter(dt, idxCountry,  e.target.value);
      document.getElementById("fCurrency").onchange = (e) => applyFilter(dt, idxCurrency, e.target.value);
      document.getElementById("fExchange").onchange = (e) => applyFilter(dt, idxExchange, e.target.value);
      document.getElementById("fSector").onchange   = (e) => applyFilter(dt, idxSector,   e.target.value);

      document.getElementById("btnReset").onclick = () => {
        document.getElementById("fCountry").value  = "";
        document.getElementById("fCurrency").value = "";
        document.getElementById("fExchange").value = "";
        document.getElementById("fSector").value   = "";
        dt.search("").columns().search("").draw();
      };
    }

    async function load(){
      try{
        setStatus("Loading data…");

        // Build header row
        document.querySelector("#tbl thead tr").innerHTML =
          columns.map(c => `<th>${c.title}</th>`).join("");

        Papa.parse(CSV_PATH, {
          download: true,
          header: true,
          skipEmptyLines: true,
          transformHeader: (h) => normHeaderKey(h),
          complete: (result) => {
            try{
              if (result.errors && result.errors.length) {
                console.warn("PapaParse errors:", result.errors);
              }
              const data = (result.data || []).filter(r => r && Object.keys(r).length > 0);

              if (!data.length) {
                setError(`No rows found in CSV: ${CSV_PATH}`);
                return;
              }

              // Convert to table rows in the exact column order
              const rows = data.map(r => {
                // normalize keys once (in case)
                const normalized = {};
                for (const k of Object.keys(r)) normalized[normHeaderKey(k)] = r[k];

                return columns.map(c => {
                  const val = normalized[c.key];
                  // numbers for sorting where possible
                  if (["Price","DividendYield_%","PayoutRatio_%","PE"].includes(c.key)) {
                    return toNumberOrEmpty(val);
                  }
                  return (val ?? "").toString().replace(/\r/g, "");
                });
              });

              // Destroy old datatable if exists
              if ($.fn.DataTable.isDataTable("#tbl")) {
                $("#tbl").DataTable().destroy();
                $("#tbl tbody").empty();
              }

              const dt = $("#tbl").DataTable({
                data: rows,
                columns: columns.map(c => ({ title: c.title })),
                pageLength: 50,
                fixedHeader: true,
                order: [[0, "desc"]]
              });

              // Meta + status
              const generated = data[0]["GeneratedUTC"] || "";
              document.getElementById("meta").textContent =
                generated ? `Generated: ${generated}` : "";
              setStatus(`Loaded ${rows.length} rows from ${CSV_PATH}`, true);

              buildFilters(dt);
            } catch (e) {
              console.error(e);
              setError("UI error while building table. See console.");
            }
          },
          error: (err) => {
            console.error(err);
            setError(`Could not load CSV: ${CSV_PATH}`);
          }
        });

      } catch (err){
        console.error(err);
        setError("Unexpected error. See console.");
      }
    }

    load();
  </script>
</body>
</html>
