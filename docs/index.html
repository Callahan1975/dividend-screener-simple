<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dividend Screener (DK + US)</title>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin: 0; background: #0b1220; color: #e7eefc; }
    header { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,.08); position: sticky; top: 0; background: #0b1220; z-index: 10; }
    h1 { margin: 0 0 6px 0; font-size: 18px; font-weight: 650; }
    .sub { margin: 0; color: rgba(231,238,252,.7); font-size: 12px; }

    .filters {
      display: grid;
      grid-template-columns: repeat(6, minmax(140px, 1fr));
      gap: 10px;
      align-items: end;
      margin-top: 10px;
    }
    .fgrp label { display:block; font-size: 11px; color: rgba(231,238,252,.7); margin-bottom: 4px; }
    .fgrp select, .fgrp input {
      width:100%; padding: 8px 10px; border:1px solid rgba(255,255,255,.12); border-radius: 10px;
      font-size: 13px; background:#0f1a2e; color:#e7eefc;
    }
    .toggles { display:flex; gap: 10px; align-items:center; padding-top: 2px; }
    .btn {
      cursor:pointer; padding: 8px 10px; border-radius: 10px; border:1px solid rgba(255,255,255,.12); background:#0f1a2e;
      font-size: 13px; color:#e7eefc;
    }
    .btn:hover { background:#12213b; }
    .wrap { padding: 14px 16px; }

    /* DataTables dark-ish */
    table.dataTable { color: #e7eefc; }
    table.dataTable thead th { border-bottom: 1px solid rgba(255,255,255,.12) !important; }
    table.dataTable tbody td { border-top: 1px solid rgba(255,255,255,.06); vertical-align: middle; }
    .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_info { color: rgba(231,238,252,.7); }
    .dataTables_wrapper .dataTables_paginate .paginate_button { color: rgba(231,238,252,.8) !important; }
    div.dataTables_filter { display:none; } /* we use our own filters */

    .badge { display:inline-block; padding: 3px 8px; border-radius: 999px; border:1px solid rgba(255,255,255,.15); font-size: 12px; background:#0f1a2e; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding: 3px 8px; border-radius: 999px; border:1px solid rgba(255,255,255,.15); background:#0f1a2e; font-size: 12px; }
    .dot { width: 8px; height: 8px; border-radius: 999px; background: #8892a6; display:inline-block; }
    .dot.add { background:#2ecc71; }
    .dot.buy { background:#27ae60; }
    .dot.hold { background:#7f8c8d; }
    .dot.trim { background:#f39c12; }
    .dot.avoid { background:#e74c3c; }

    .right { text-align:right; }
    .small { font-size: 12px; color: rgba(231,238,252,.75); }
  </style>
</head>

<body>
  <header>
    <h1>Dividend Screener (DK + US)</h1>
    <p class="sub" id="meta">Loader…</p>

    <div class="filters">
      <div class="fgrp"><label>Country</label><select id="fltCountry"><option value="">All</option></select></div>
      <div class="fgrp"><label>Currency</label><select id="fltCurrency"><option value="">All</option></select></div>
      <div class="fgrp"><label>Sector</label><select id="fltSector"><option value="">All</option></select></div>
      <div class="fgrp"><label>Exchange</label><select id="fltExchange"><option value="">All</option></select></div>
      <div class="fgrp"><label>InIndex</label><select id="fltInIndex"><option value="">All</option></select></div>
      <div class="fgrp"><label>Portfolio (Owned)</label>
        <select id="fltOwned">
          <option value="">All</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>

      <div class="fgrp"><label>Signal</label><select id="fltSignal"><option value="">All</option></select></div>
      <div class="fgrp"><label>Confidence</label><select id="fltConfidence"><option value="">All</option></select></div>
      <div class="fgrp"><label>Reco</label><select id="fltReco"><option value="">All</option></select></div>
      <div class="fgrp"><label>Action</label><select id="fltAction"><option value="">All</option></select></div>
      <div class="fgrp"><label>PortfolioAction</label><select id="fltPortfolioAction"><option value="">All</option></select></div>
      <div class="fgrp">
        <label>&nbsp;</label>
        <div class="toggles">
          <button class="btn" id="btnReset">Reset</button>
          <label class="small"><input type="checkbox" id="tglAdvanced"> Show advanced</label>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <table id="tbl" class="display" style="width:100%"></table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

  <script>
    // <-- Din CSV (justér hvis din sti er anderledes)
    const CSV_URL = "../data/screener_results/screener_results.csv";

    // Slim default kolonner (det vi viser som standard)
    const DEFAULT_VISIBLE = [
      "Ticker","Name","Country","Sector",
      "Portfolio","PortfolioAction",
      "Signal","Confidence","Reco","Action",
      "Price","DividendYield_%","PayoutRatio_%","PE"
    ];

    // Alt andet betragtes som "advanced" (skjult indtil toggle)
    function parseCSV(text) {
      const rows = [];
      let row = [], cell = "", inQuotes = false;
      for (let i=0; i<text.length; i++) {
        const c = text[i], n = text[i+1];
        if (c === '"') {
          if (inQuotes && n === '"') { cell += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (c === ',' && !inQuotes) {
          row.push(cell); cell = "";
        } else if ((c === '\n' || c === '\r') && !inQuotes) {
          if (c === '\r' && n === '\n') i++;
          row.push(cell);
          if (row.join("").trim().length) rows.push(row);
          row = []; cell = "";
        } else {
          cell += c;
        }
      }
      if (cell.length || row.length) { row.push(cell); rows.push(row); }
      return rows;
    }

    function uniqSorted(arr) {
      return [...new Set(arr.filter(v => v !== null && v !== undefined && String(v).trim() !== ""))]
        .map(v => String(v))
        .sort((a,b) => a.localeCompare(b));
    }

    function setDropdown(sel, values) {
      const el = document.getElementById(sel);
      const current = el.value;
      el.innerHTML = '<option value="">All</option>' + values.map(v => `<option value="${v}">${v}</option>`).join("");
      if ([...el.options].some(o => o.value === current)) el.value = current;
    }

    function fmtNum(x, digits=2) {
      const n = Number(x);
      if (!isFinite(n)) return "";
      return n.toFixed(digits);
    }

    function actionDot(a) {
      const v = String(a||"").toUpperCase();
      if (v.includes("ADD")) return 'add';
      if (v.includes("BUY")) return 'buy';
      if (v.includes("HOLD")) return 'hold';
      if (v.includes("TRIM")) return 'trim';
      if (v.includes("AVOID")) return 'avoid';
      return '';
    }

    async function init() {
      const r = await fetch(CSV_URL, { cache: "no-store" });
      if (!r.ok) throw new Error("Kunne ikke loade CSV: " + CSV_URL);
      const text = await r.text();
      const parsed = parseCSV(text);

      const headers = parsed[0].map(h => h.trim());
      const rows = parsed.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = (row[i] ?? "").trim());
        return obj;
      });

      document.getElementById("meta").textContent = `Rows: ${rows.length} • Source: ${CSV_URL.replace("../","")}`;

      // Build columns
      const columns = headers.map(h => {
        const visible = DEFAULT_VISIBLE.includes(h);

        let render = null;

        if (h === "Ticker") {
          render = (data) => `<span class="badge">${String(data||"")}</span>`;
        }

        if (h === "PortfolioAction" || h === "Action") {
          render = (data) => {
            const a = String(data||"");
            const cls = actionDot(a);
            return `<span class="pill"><span class="dot ${cls}"></span><span>${a}</span></span>`;
          };
        }

        if (["Price","PE","DividendRate"].includes(h)) {
          render = (data) => `<span class="right">${fmtNum(data,2)}</span>`;
        }

        if (h === "DividendYield_%" || h === "PayoutRatio_%") {
          render = (data) => `<span class="right">${fmtNum(data,2)}%</span>`;
        }

        return { title: h, data: h, visible, render };
      });

      const table = $("#tbl").DataTable({
        data: rows,
        columns,
        pageLength: 50,
        order: [],
        fixedHeader: true
      });

      // Populate dropdowns if columns exist
      const colVals = (col) => headers.includes(col) ? uniqSorted(rows.map(r => r[col])) : [];
      setDropdown("fltCountry", colVals("Country"));
      setDropdown("fltCurrency", colVals("Currency"));
      setDropdown("fltSector", colVals("Sector"));
      setDropdown("fltExchange", colVals("Exchange"));
      setDropdown("fltInIndex", colVals("InIndex"));
      setDropdown("fltSignal", colVals("Signal"));
      setDropdown("fltConfidence", colVals("Confidence"));
      setDropdown("fltReco", colVals("Reco"));
      setDropdown("fltAction", colVals("Action"));
      setDropdown("fltPortfolioAction", colVals("PortfolioAction"));

      function applyFilters() {
        const f = {
          Country: document.getElementById("fltCountry").value,
          Currency: document.getElementById("fltCurrency").value,
          Sector: document.getElementById("fltSector").value,
          Exchange: document.getElementById("fltExchange").value,
          InIndex: document.getElementById("fltInIndex").value,
          Signal: document.getElementById("fltSignal").value,
          Confidence: document.getElementById("fltConfidence").value,
          Reco: document.getElementById("fltReco").value,
          Action: document.getElementById("fltAction").value,
          PortfolioAction: document.getElementById("fltPortfolioAction").value,
          Owned: document.getElementById("fltOwned").value
        };

        // Clear any previous custom filters
        $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(fn => fn.__ours !== true);

        const fn = function(settings, data, dataIndex) {
          const row = table.row(dataIndex).data() || {};

          for (const k of ["Country","Currency","Sector","Exchange","InIndex","Signal","Confidence","Reco","Action","PortfolioAction"]) {
            if (f[k] && String(row[k] || "") !== f[k]) return false;
          }

          // Owned filter uses Portfolio column with Yes/No (as in your screenshot)
          if (f.Owned) {
            const p = String(row["Portfolio"] || "").toLowerCase();
            if (f.Owned === "yes" && p !== "yes") return false;
            if (f.Owned === "no" && p !== "no") return false;
          }

          return true;
        };
        fn.__ours = true;
        $.fn.dataTable.ext.search.push(fn);

        table.draw();
      }

      ["fltCountry","fltCurrency","fltSector","fltExchange","fltInIndex","fltSignal","fltConfidence","fltReco","fltAction","fltPortfolioAction","fltOwned"]
        .forEach(id => document.getElementById(id).addEventListener("change", applyFilters));

      document.getElementById("btnReset").addEventListener("click", () => {
        ["fltCountry","fltCurrency","fltSector","fltExchange","fltInIndex","fltSignal","fltConfidence","fltReco","fltAction","fltPortfolioAction","fltOwned"]
          .forEach(id => document.getElementById(id).value = "");
        applyFilters();
      });

      // Advanced toggle: show/hide all non-default columns
      document.getElementById("tglAdvanced").addEventListener("change", (e) => {
        const on = e.target.checked;
        headers.forEach((h, idx) => {
          const shouldShow = DEFAULT_VISIBLE.includes(h) ? true : on;
          table.column(idx).visible(shouldShow, false);
        });
        table.columns.adjust().draw(false);
      });

      applyFilters();
    }

    init().catch(err => {
      document.getElementById("meta").textContent = "Error: " + err.message;
      console.error(err);
    });
  </script>
</body>
</html>
