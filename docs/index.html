<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Dividend Screener – Decision View</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>

<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto; margin:18px; }
h1 { font-size:22px; margin-bottom:6px; }
.sub { font-size:13px; color:#555; margin-bottom:10px; }

.filters select {
  margin-right:10px;
  padding:4px 6px;
}

.details {
  background:#fafafa;
  border:1px solid #eee;
  border-radius:8px;
  padding:10px;
  font-size:12px;
}
.details-grid {
  display:grid;
  grid-template-columns:140px 1fr;
  gap:6px 12px;
}
.muted { color:#666; }
td.details-control { cursor:pointer; text-align:center; width:28px; }
</style>
</head>

<body>

<h1>Dividend Screener – Decision View</h1>
<p class="sub">Live data from <code>data/screener_results/screener_results.csv</code></p>

<div class="filters">
  Country:
  <select id="filterCountry"><option value="">All</option></select>

  Sector:
  <select id="filterSector"><option value="">All</option></select>
</div>

<br/>

<table id="tbl" class="display" style="width:100%">
<thead>
<tr>
  <th></th>
  <th>Name</th>
  <th>Country</th>
  <th>Sector</th>
  <th>Currency</th>
  <th>Price</th>
  <th>Dividend Yield %</th>
  <th>Payout Ratio %</th>
  <th>PE</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const CSV = "data/screener_results/screener_results.csv";

function num(v,d=2){const n=Number(v);return Number.isFinite(n)?n.toFixed(d):"";}
function pct(v,d=2){const n=Number(v);return Number.isFinite(n)?n.toFixed(d)+"%":"";}

function details(r){
  const f = [
    ["Ticker",r.Ticker],
    ["Industry",r.Industry],
    ["Exchange",r.Exchange],
    ["Price",num(r.Price)],
    ["Dividend Yield",pct(r["DividendYield_%"])],
    ["Payout Ratio",pct(r["PayoutRatio_%"])],
    ["PE",num(r.PE,1)]
  ];
  let h=`<div class="details"><div class="details-grid">`;
  f.forEach(x=>h+=`<div class="muted">${x[0]}</div><div>${x[1]??""}</div>`);
  return h+"</div></div>";
}

Papa.parse(CSV,{
  download:true, header:true, skipEmptyLines:true,
  complete:r=>{
    const data=r.data;

    const countries=[...new Set(data.map(x=>x.Country).filter(Boolean))].sort();
    const sectors=[...new Set(data.map(x=>x.Sector).filter(Boolean))].sort();

    countries.forEach(c=>$("#filterCountry").append(`<option>${c}</option>`));
    sectors.forEach(s=>$("#filterSector").append(`<option>${s}</option>`));

    const table=$("#tbl").DataTable({
      data:data,
      pageLength:50,
      columns:[
        {className:"details-control",orderable:false,data:null,defaultContent:"▶"},
        {data:"Name"},
        {data:"Country"},
        {data:"Sector"},
        {data:"Currency"},
        {data:"Price",render:d=>num(d)},
        {data:"DividendYield_%",render:d=>pct(d)},
        {data:"PayoutRatio_%",render:d=>pct(d,1)},
        {data:"PE",render:d=>num(d,1)}
      ]
    });

    $("#tbl tbody").on("click","td.details-control",function(){
      const tr=$(this).closest("tr");
      const row=table.row(tr);
      const i=row.index();
      if(row.child.isShown()){
        row.child.hide(); $(this).text("▶");
      } else {
        row.child(details(data[i])).show(); $(this).text("▼");
      }
    });

    $("#filterCountry").on("change",()=>table.column(2).search($("#filterCountry").val()).draw());
    $("#filterSector").on("change",()=>table.column(3).search($("#filterSector").val()).draw());
  }
});
</script>

</body>
</html>
