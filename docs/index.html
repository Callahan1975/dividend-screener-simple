<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dividend Screener (DK + US)</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; margin: 20px; }
    h1 { margin: 0 0 10px 0; }
    #status { margin: 8px 0 16px 0; opacity: 0.85; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
    .filters label { display: flex; gap: 6px; align-items: center; }
    select { padding: 4px 6px; }
    table.dataTable thead th { white-space: nowrap; }
  </style>
</head>

<body>
  <h1>Dividend Screener (DK + US)</h1>
  <div id="status">Loading data…</div>

  <div class="filters" id="filters"></div>

  <table id="screener" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // For GitHub Pages project site (…/dividend-screener-simple/), this relative path is correct:
    const CSV_PATH = "data/screener_results/screener_results.csv";

    function uniqueSorted(values) {
      const s = new Set(values.filter(v => v !== null && v !== undefined && String(v).trim() !== ""));
      return Array.from(s).sort((a,b) => String(a).localeCompare(String(b)));
    }

    function addDropdownFilter(dt, colName) {
      const idx = dt.column(`${colName}:name`).index();
      if (idx === undefined) return;

      const col = dt.column(idx);
      const values = uniqueSorted(col.data().toArray());

      const id = `f_${colName}`;
      const $wrap = $(`
        <label>
          <span>${colName}</span>
          <select id="${id}">
            <option value="">All</option>
          </select>
        </label>
      `);

      const $sel = $wrap.find("select");
      values.forEach(v => $sel.append(`<option value="${String(v)}">${String(v)}</option>`));

      $sel.on("change", function() {
        const v = this.value;
        // exact match
        col.search(v ? `^${$.fn.dataTable.util.escapeRegex(v)}$` : "", true, false).draw();
      });

      $("#filters").append($wrap);
    }

    Papa.parse(CSV_PATH, {
      download: true,
      header: true,
      skipEmptyLines: true,
      dynamicTyping: false,
      complete: function(results) {
        if (!results || !results.data) {
          document.getElementById("status").innerText = `Error: Could not parse CSV: ${CSV_PATH}`;
          return;
        }

        const data = results.data;
        const fields = results.meta && results.meta.fields ? results.meta.fields : [];

        if (data.length === 0 || fields.length === 0) {
          document.getElementById("status").innerText = `No data in CSV: ${CSV_PATH}`;
          return;
        }

        // Build header
        const thead = "<tr>" + fields.map(f => `<th>${f}</th>`).join("") + "</tr>";
        $("#screener thead").html(thead);

        // DataTables wants columns + data objects
        const columns = fields.map(f => ({ title: f, data: f, name: f }));

        const dt = $("#screener").DataTable({
          data,
          columns,
          pageLength: 50,
          deferRender: true,
          order: [],
          autoWidth: false
        });

        // Update status
        const gen = (data[0] && data[0].GeneratedUTC) ? ` • Generated: ${data[0].GeneratedUTC}` : "";
        document.getElementById("status").innerText = `Loaded ${data.length} rows from ${CSV_PATH}${gen}`;

        // Add dropdown filters if these columns exist
        ["Country", "Currency", "Exchange", "Sector"].forEach(c => {
          if (fields.includes(c)) addDropdownFilter(dt, c);
        });
      },
      error: function(err) {
        document.getElementById("status").innerText = `Error loading CSV: ${CSV_PATH} (${err})`;
      }
    });
  </script>
</body>
</html>
